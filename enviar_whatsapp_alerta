import requests
import os
from dotenv import load_dotenv

load_dotenv()

ZAPI_TOKEN = os.getenv("ZAPI_TOKEN")
ZAPI_INSTANCE = os.getenv("ZAPI_INSTANCE")

def enviar_whatsapp_alerta(crianca_id, motivo):
    conn = get_db_connection()
    cursor = conn.cursor(dictionary=True)
    
    # Busca dados da criança
    cursor.execute("SELECT nome FROM criancas WHERE id = %s", (crianca_id,))
    crianca = cursor.fetchone()
    
    # Busca responsáveis
    cursor.execute("SELECT nome, telefone_whatsapp FROM responsaveis WHERE crianca_id = %s", (crianca_id,))
    responsaveis = cursor.fetchall()
    cursor.close()
    conn.close()

    for resp in responsaveis:
        mensagem = f"Oi, {resp['nome']}! Aqui é do Ministério Kids da Igreja Mais de Cristo Canasvieiras. Sua(o) filha(o) {crianca['nome']} está precisando de você no cultinho. Motivo: {motivo}. Pode vir até a Sala Kids? ❤️"
        
        url = f"https://api.z-api.io/instances/3E6F0EC5A375B0F52279DEB451C64861/token/AE05E279E059098F580230C0/send-text/send-messages"
        payload = {
            "phone": resp['telefone_whatsapp'],
            "message": mensagem
        }
        headers = {'Content-Type': 'application/json'}
        requests.post(url, json=payload, headers=headers)
